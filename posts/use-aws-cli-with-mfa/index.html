<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://howto.pandey.me/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Use AWS CLI With MFA</title>
<script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","d6qfzorlb9")</script></head><body><header id=banner><h2><a href=https://howto.pandey.me/>How To...</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/tags title=tags>tags</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Use AWS CLI With MFA</h1><div><time>September 23, 2024</time></div></header><p>When you have MFA enabled in your AWS account, certain commands may not work with a simple access key and secret key. You need to get a session token and use that instead. Here are the steps to get a session token.</p><ol><li>Make sure you AWS CLI installed and configured with your access key and secret key. Following steps assume that these credentials are set as the default profile; if not, then add <code>--profile profile-name</code> at the end of each command.</li><li>Find out the ARN of you MFA device.<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>aws iam list-mfa-devices
</span></span></code></pre></div></li><li>Get code from your MFA device.</li><li>Get a session token.<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>aws sts get-session-token --serial-number arn-of-the-mfa-device --token-code code-from-mfa-device
</span></span></code></pre></div>This will return an output like this:<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Credentials&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;SecretAccessKey&#34;</span><span class=p>:</span> <span class=s2>&#34;secret-access-key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;SessionToken&#34;</span><span class=p>:</span> <span class=s2>&#34;temporary-session-token&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Expiration&#34;</span><span class=p>:</span> <span class=s2>&#34;expiration-date-time&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;AccessKeyId&#34;</span><span class=p>:</span> <span class=s2>&#34;access-key-id&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li>Add these credentials to your AWS CLI configuration. Change <code>--profile mfa</code> to whatever profile name you want to use.<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>aws configure <span class=nb>set</span> aws_access_key_id access-key-id --profile mfa
</span></span><span class=line><span class=cl>aws configure <span class=nb>set</span> aws_secret_access_key secret-access-key --profile mfa
</span></span><span class=line><span class=cl>aws configure <span class=nb>set</span> aws_session_token temporary-session-token --profile mfa
</span></span></code></pre></div></li><li>You can now use the <code>mfa</code> profile to run commands that require MFA.<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>aws s3 ls --profile mfa
</span></span></code></pre></div></li></ol><p><a href=https://repost.aws/knowledge-center/authenticate-mfa-cli>source</a></p></article></main><footer id=footer>Â© 2024 Sunil Pandey</footer></body></html>