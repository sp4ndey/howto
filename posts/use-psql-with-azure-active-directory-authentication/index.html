<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://howto.pandey.me/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Use psql with Azure Active Directory authentication</title>
<script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","d6qfzorlb9")</script></head><body><header id=banner><h2><a href=https://howto.pandey.me/>How To...</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/tags title=tags>tags</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Use psql with Azure Active Directory authentication</h1><div><time>April 17, 2023</time></div></header><p>I needed to connect to an <a href=https://azure.microsoft.com/en-us/products/postgresql/>Azure Database for PostgreSQL</a> which uses <a href=https://azure.microsoft.com/en-us/products/active-directory>Azure Active Directory</a> for authentication. Despite the many GUI clients available, I prefer using <a href=https://www.postgresql.org/docs/current/app-psql.html>psql</a>. Fortunately, it&rsquo;s fairly easy to connect using psql.</p><p>The following steps are taken from <a href=https://learn.microsoft.com/en-us/azure/postgresql/single-server/how-to-configure-sign-in-azure-ad-authentication>here</a>.</p><h3 id=step-1---install-azure-cli>Step 1 - Install Azure CLI</h3><p>On macOS, the simplest method is to use Homebrew:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>brew update <span class=o>&amp;&amp;</span> brew install azure-cli
</span></span></code></pre></div><p>Detailed instructions can be found <a href=https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-macos>here</a>.</p><h3 id=step-2---login-to-azure>Step 2 - Login to Azure</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>az login
</span></span></code></pre></div><p>This command will open a browser window where you can login to Azure.</p><h3 id=step-3---retrieve-and-set-azure-ad-access-token-as-the-password>Step 3 - Retrieve and set Azure AD access token as the password</h3><p>Next, we need to get an access token from Azure AD and set that in the <code>PGPASSWORD</code> environment variable so psql can access it. This is easy to do if you have <a href=https://stedolan.github.io/jq/>jq</a> installed.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PGPASSWORD</span><span class=o>=</span><span class=k>$(</span>az account get-access-token --resource-type oss-rdbms <span class=p>|</span> jq -r <span class=s1>&#39;.accessToken&#39;</span><span class=k>)</span>
</span></span></code></pre></div><h3 id=step-4---connect-using-psql>Step 4 - Connect using psql</h3><p>That was it! You are ready to connect to the server using psql:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>psql <span class=s2>&#34;host=... user=... dbname=... sslmode=require&#34;</span>
</span></span></code></pre></div><p>You can also combine the previous two commands, which can be useful if you want to create an alias:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>PGPASSWORD</span><span class=o>=</span><span class=k>$(</span>az account get-access-token --resource-type oss-rdbms <span class=p>|</span> jq -r <span class=s1>&#39;.accessToken&#39;</span><span class=k>)</span> psql <span class=s2>&#34;host=... user=... dbname=... sslmode=require&#34;</span>
</span></span></code></pre></div></article></main><footer id=footer>Â© 2024 Sunil Pandey</footer></body></html>